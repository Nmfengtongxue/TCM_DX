import{medicineData}from"./data.js";import{getPinyinFirstLetter,getFullPinyin}from"./utils.js";let prescriptionInput=null,searchBtn=null,resetBtn=null,medicineList=null,doseInput=null,subtotalPriceElement=null,shippingFeeInput=null,shippingFeeLabel=null,totalPriceElement=null,customerName=null,customerAge=null,customerPhone=null,saveJsonBtn=null,saveTxtBtn=null,saveImageBtn=null,settlementBtn=null,settlementModal=null,settlementClose=null,cancelSettlementBtn=null,confirmSettlementBtn=null,modalCustomerName=null,modalCustomerAge=null,modalCustomerPhone=null,modalPrescriptionDate=null,modalDose=null,modalMedicinesList=null,modalSubtotal=null,modalShippingFee=null,modalTotal=null,paymentModal=null,paymentClose=null,closePaymentBtn=null,paymentAmount=null,helpBtn=null,helpModal=null,helpClose=null,closeHelpBtn=null,currentPrescription=(document.addEventListener("DOMContentLoaded",function(){prescriptionInput=document.getElementById("prescriptionInput"),searchBtn=document.getElementById("searchBtn"),resetBtn=document.getElementById("resetBtn"),medicineList=document.getElementById("medicineList"),doseInput=document.getElementById("doseInput"),subtotalPriceElement=document.getElementById("subtotalPrice"),shippingFeeInput=document.getElementById("shippingFeeInput"),shippingFeeLabel=document.getElementById("shippingFeeLabel"),totalPriceElement=document.getElementById("totalPrice"),customerName=document.getElementById("customerName"),customerAge=document.getElementById("customerAge"),customerPhone=document.getElementById("customerPhone"),saveJsonBtn=document.getElementById("saveJsonBtn"),saveTxtBtn=document.getElementById("saveTxtBtn"),saveImageBtn=document.getElementById("saveImageBtn"),settlementBtn=document.getElementById("settlementBtn"),settlementModal=document.getElementById("settlementModal"),settlementClose=document.getElementById("settlementClose"),cancelSettlementBtn=document.getElementById("cancelSettlementBtn"),confirmSettlementBtn=document.getElementById("confirmSettlementBtn"),modalCustomerName=document.getElementById("modalCustomerName"),modalCustomerAge=document.getElementById("modalCustomerAge"),modalCustomerPhone=document.getElementById("modalCustomerPhone"),modalPrescriptionDate=document.getElementById("modalPrescriptionDate"),modalDose=document.getElementById("modalDose"),modalMedicinesList=document.getElementById("modalMedicinesList"),modalSubtotal=document.getElementById("modalSubtotal"),modalShippingFee=document.getElementById("modalShippingFee"),modalTotal=document.getElementById("modalTotal"),paymentModal=document.getElementById("paymentModal"),paymentClose=document.getElementById("paymentClose"),closePaymentBtn=document.getElementById("closePaymentBtn"),paymentAmount=document.getElementById("paymentAmount"),helpBtn=document.getElementById("helpBtn"),helpModal=document.getElementById("helpModal"),helpClose=document.getElementById("helpClose"),closeHelpBtn=document.getElementById("closeHelpBtn"),initEventListeners()}),{dose:1,medicines:[]}),DEFAULT_SHIPPING_FEE=20,FREE_SHIPPING_THRESHOLD=200,traditionalUnitConversion={"两":30,"钱":3,"分":.3,"厘":.03,"斤":500,g:1,"克":1};function convertTraditionalToGram(e,t){t=traditionalUnitConversion[t];return t?e*t:e}function parseTraditionalDose(e){var t=e.match(/(\d+(?:\.\d+)?)([\u4e00-\u9fa5a-zA-Z]+)/);return(t=t||e.match(/(\d+)([\u4e00-\u9fa5]+)/))?{quantity:parseFloat(t[1]),unit:t[2].trim()}:{quantity:0,unit:""}}let HERB_DICT=["炙黄芪","生黄芪","赤芍","白芍","桂枝","肉桂","甘草","干姜","红枣","当归","龟甲","龟板","党参","丁香","黄芪","大枣","炙甘草","甘草片"].sort((e,t)=>t.length-e.length),medicineAliases={"红枣":["大枣"],"生黄芪":["黄芪"],"甘草":["甘草","炙甘草","甘草片"]};function getAllPossibleNames(e){return medicineAliases[e]?[e,...medicineAliases[e]]:[e]}function extractHerbAndDose(e){e=e.match(/^([\u4e00-\u9fa5]+)\s*(\d+(\.\d+)?)\s*g?$/i);if(e){let t=e[1];e=parseFloat(e[2]);if(HERB_DICT.some(e=>e===t))return{drug:t,quantity:e,unit:"g"}}return null}function parseLine(i){if(!(i=i.replace(/\d+\s*剂/g,"").trim()))return[];var t,a=[];if(i.includes("，")||i.includes(","))for(t of i.split(/[,，]\s*/)){let e=extractHerbAndDose(t.trim());if(e)a.push(e);else{let e=t.trim().match(/^([\u4e00-\u9fa5]+)$/);if(e){let t=e[1];HERB_DICT.some(e=>e===t)&&a.push({drug:t,quantity:0,unit:""})}}}else{let e=extractHerbAndDose(i);if(e)return[e];var o=i.match(/(\d+(\.\d+)?)\s*g?\s*$/i);if(o){var r=parseFloat(o[1]);let t=i.slice(0,o.index).trim();for(;t;){let e=!1;for(var l of HERB_DICT)if(t.startsWith(l)){a.push({drug:l,quantity:r,unit:"g"}),t=t.slice(l.length).trim(),e=!0;break}if(!e)break}if(0<a.length)return a}let n=i.match(/^([\u4e00-\u9fa5]+)$/);if(n){let t=n[1];HERB_DICT.some(e=>e===t)&&a.push({drug:t,quantity:0,unit:""})}}return a}function preprocessPrescription(e){var t=/[\u4e00-\u9fa5a-zA-Z]+/g,n=/\d+(?:\.\d+)?(?:[a-zA-Z一-龥]+)?/g,i=[],a=[];let o;for(;null!==(o=t.exec(e));)i.push({text:o[0],index:o.index});for(;null!==(o=n.exec(e));)a.push({text:o[0],index:o.index});var r=[...i.map(e=>({...e,type:"A"})),...a.map(e=>({...e,type:"B"}))],l=(r.sort((e,t)=>e.index-t.index),[]);let s="";for(let e=0;e<r.length;e++){var d=r[e],c=r[e+1];s+=d.text,c?("A"===d.type&&"A"===c.type||"B"===d.type&&"A"===c.type)&&(l.push(s),s=""):l.push(s)}return l.join("\n")}function parsePrescription(e){let t=1;var n=/(\d+)\s*剂/g.exec(e);n&&(t=parseInt(n[1]));var i,a,o=[];for(i of preprocessPrescription(e).split("\n"))for(a of parseLine(i))o.push({name:a.drug,quantity:a.quantity,unit:a.unit});return 0===o.length?{medicines:e.split(/[,，\s]+/).filter(e=>""!==e.trim()).map(e=>({name:e,quantity:0,unit:""})),dose:t}:{medicines:o,dose:t}}function searchMedicines(){var t=prescriptionInput.value.trim();if(t){var t=parsePrescription(t),n=t.medicines,t=t.dose,i=(currentPrescription.dose=t,doseInput.value=t,[]),a=[],r=[];for(let o of n){var l=medicineData.filter(e=>{if("合计"===e.商品名称||NaN===e.商品编码)return!1;var t;let n=!1;for(t of getAllPossibleNames(o.name))if(e.商品名称.includes(t)||e.国家医保名称&&e.国家医保名称.includes(t)){n=!0;break}var i=getFullPinyin(e.商品名称).includes(o.name.toLowerCase())||e.国家医保名称&&getFullPinyin(e.国家医保名称).includes(o.name.toLowerCase()),a=getPinyinFirstLetter(e.商品名称).includes(o.name.toLowerCase())||e.国家医保名称&&getPinyinFirstLetter(e.国家医保名称).includes(o.name.toLowerCase());return n||i||a});0<l.length?(i.push({parsed:o,medicines:l}),1<l.length&&r.push({name:o.name,count:l.length,matches:l.map(e=>e.商品名称)})):a.push({name:o.name,quantity:o.quantity,unit:o.unit})}let e="";if(0<a.length&&(t=a.map(e=>`"${e.name}"`).join("、"),e+=`<div class="alert alert-warning">未找到以下药材：${t}，请检查输入是否正确。</div>`),0<r.length&&(n=r.map(e=>`"${e.name}"`).join("、"),e+=`<div class="alert alert-info">以下药材找到多个匹配结果（${n}），您可以通过下拉菜单手动选择。</div>`),0===i.length)medicineList.innerHTML=e+'<div class="not-found">未找到匹配的药材</div>';else{let r=e,l=0;function o(e){var t=parseFloat(e.target.value)||0,n=JSON.parse(e.target.dataset.allMedicines)[parseInt(e.target.dataset.medicineIndex)||0],n=calculatePrice(parseFloat(n.售价),t,currentPrescription.dose),n=(e.target.nextElementSibling.textContent="¥"+n.totalPrice.toFixed(2),e.target.closest(".medicine-item").querySelector(".add-to-prescription-btn")),n=(n&&(n.dataset.quantity=t),e.target.closest(".medicine-item").querySelector(".medicine-select"));n&&(n.dataset.quantity=t)}i.forEach((e,t)=>{var n,i,a,{parsed:e,medicines:o}=e;1===o.length?(n=o[0],i=parseFloat(n.售价),a=currentPrescription.dose,a=e.quantity*i*a,r+=`
                <div class="medicine-item">
                    <div class="medicine-info">
                        <div class="medicine-name">${n.商品名称}</div>
                        <div class="medicine-details">单位: ${n.单位} | 单价: ¥${i.toFixed(3)}</div>
                    </div>
                    <input type="number" min="0" step="0.1" value="${e.quantity}" class="quantity-input" data-item-index="${l}" data-medicine-index="0" data-all-medicines='${JSON.stringify(o)}'>
                    <div class="medicine-price">¥${a.toFixed(2)}</div>
                    <button class="add-to-prescription-btn" data-item-index="${l}" data-all-medicines='${JSON.stringify(o)}' data-quantity="${e.quantity}">添加到处方</button>
                </div>
            `):(r+=`
                <div class="medicine-item">
                    <div class="medicine-info">
                        <div class="medicine-name">
                            <select class="medicine-select" data-item-index="${l}" data-all-medicines='${JSON.stringify(o)}' data-quantity="${e.quantity}">
            `,o.forEach((e,t)=>{var n=0===t?"selected":"";r+=`<option value="${t}" ${n}>${e.商品名称}</option>`}),n=o[0],i=parseFloat(n.售价),a=currentPrescription.dose,a=calculatePrice(i,e.quantity,a),r+=`
                            </select>
                        </div>
                        <div class="medicine-details">单位: ${n.单位} | 单价: ¥${i.toFixed(3)} <span class="multiple-match-hint">（找到${o.length}个匹配结果）</span></div>
                    </div>
                    <input type="number" min="0" step="0.1" value="${e.quantity}" class="quantity-input" data-item-index="${l}" data-all-medicines='${JSON.stringify(o)}' data-medicine-index="0">
                    <div class="medicine-price">¥${a.totalPrice.toFixed(2)}</div>
                    <button class="add-to-prescription-btn" data-item-index="${l}" data-all-medicines='${JSON.stringify(o)}' data-quantity="${e.quantity}">添加到处方</button>
                </div>
            `),l++}),medicineList.innerHTML=r,document.querySelectorAll(".quantity-input").forEach(e=>{e.addEventListener("input",o)}),document.querySelectorAll(".medicine-select").forEach(e=>{e.addEventListener("change",e=>{updateSearchResultPrice(e.target)})}),doseInput.value=currentPrescription.dose,updateTotalPrice()}}else medicineList.innerHTML='<div class="not-found">请输入药材名称</div>'}function updateQuantity(e){var t=parseInt(e.target.dataset.index),n=parseFloat(e.target.value)||0,i=n*parseFloat(currentPrescription.medicines[t].售价),a=i*currentPrescription.dose;currentPrescription.medicines[t].quantity=n,currentPrescription.medicines[t].singlePrice=i,currentPrescription.medicines[t].totalPrice=a,e.target.nextElementSibling.textContent="¥"+a.toFixed(2),updateTotalPrice()}function updateTotalPrice(){var e=currentPrescription.medicines.reduce((e,t)=>e+t.totalPrice,0);subtotalPriceElement.textContent=e.toFixed(2);let t=0;e<FREE_SHIPPING_THRESHOLD?(t=DEFAULT_SHIPPING_FEE,shippingFeeLabel.textContent="（不满200元需支付运费）"):(t=0,shippingFeeLabel.textContent="（满200元免运费）"),shippingFeeInput.value=t;e+=parseFloat(shippingFeeInput.value);totalPriceElement.textContent=e.toFixed(2)}function resetForm(){prescriptionInput.value="",customerName.value="",customerAge.value="",customerPhone.value="",medicineList.innerHTML='<div class="not-found">请输入药材名称并点击检索</div>',subtotalPriceElement.textContent="0.00",shippingFeeInput.value="0",shippingFeeLabel.textContent="（满200元免运费）",totalPriceElement.textContent="0.00",doseInput.value="1",currentPrescription={dose:1,medicines:[]}}function updateShippingFee(){updateTotalPrice()}function updateDose(){let n=parseInt(doseInput.value)||1;currentPrescription.dose=n,currentPrescription.medicines.forEach(e=>{var t=calculatePrice(parseFloat(e.售价),e.quantity,n);e.singlePrice=t.singlePrice,e.totalPrice=t.totalPrice}),document.querySelectorAll(".medicine-price").forEach((e,t)=>{t<currentPrescription.medicines.length&&(e.textContent="¥"+currentPrescription.medicines[t].totalPrice.toFixed(2))}),document.querySelectorAll(".quantity-input").forEach(e=>{var t=JSON.parse(e.dataset.allMedicines)[parseInt(e.dataset.medicineIndex)||0],t=calculatePrice(parseFloat(t.售价),parseFloat(e.value)||0,n);e.nextElementSibling.textContent="¥"+t.totalPrice.toFixed(2)}),updateTotalPrice()}function saveAsJson(){var e;0===currentPrescription.medicines.length?alert("请先检索并填写处方信息"):(e={customer:{name:customerName.value,age:customerAge.value,phone:customerPhone.value},dose:currentPrescription.dose,medicines:currentPrescription.medicines.map(e=>({name:e.商品名称,unit:e.单位,quantity:e.quantity,pricePerUnit:parseFloat(e.售价),singlePrice:e.singlePrice,totalPrice:e.totalPrice})),subtotal:parseFloat(subtotalPriceElement.textContent),shippingFee:parseFloat(shippingFeeInput.value),totalAmount:parseFloat(totalPriceElement.textContent)},downloadFile("prescription.json",JSON.stringify(e,null,2),"application/json"))}function saveAsTxt(){if(0===currentPrescription.medicines.length)alert("请先检索并填写处方信息");else{let t="中药饮片处方\n";t=(t=(t=(t=(t=(t+="====================\n")+`顾客姓名: ${customerName.value||"未填写"}
`)+`年龄: ${customerAge.value||"未填写"}
`)+`联系方式: ${customerPhone.value||"未填写"}
`)+`剂数: ${currentPrescription.dose}剂
`)+"-------------------\n"+"药材清单:\n",currentPrescription.medicines.forEach(e=>{0<e.quantity&&(t+=`${e.商品名称} ${e.quantity}${e.单位} × ${currentPrescription.dose}剂 = ¥${e.totalPrice.toFixed(2)}\n`)}),downloadFile("prescription.txt",t=(t=(t=(t=(t+="-------------------\n")+`商品总价: ¥${parseFloat(subtotalPriceElement.textContent).toFixed(2)}
`)+`运费: ¥${parseFloat(shippingFeeInput.value).toFixed(2)}
`)+`总计: ¥${parseFloat(totalPriceElement.textContent).toFixed(2)}
`)+("\n处方日期: "+(new Date).toLocaleDateString("zh-CN")),"text/plain")}}function saveAsImage(){if(0===currentPrescription.medicines.length)alert("请先检索并填写处方信息");else{let n=document.createElement("div"),t=(n.style.position="absolute",n.style.left="-9999px",n.style.backgroundColor="white",n.style.padding="20px",n.style.borderRadius="10px",n.style.boxShadow="0 4px 12px rgba(0,0,0,0.1)",n.style.width="500px",n.style.fontFamily='"Microsoft YaHei", sans-serif','<h2 style="text-align:center; color:#2c3e50; margin-bottom:20px;">中药饮片处方</h2>');t=(t=(t=(t=(t=(t=(t=(t=(t+=`<p><strong>顾客姓名:</strong> ${customerName.value||"未填写"}</p>`)+`<p><strong>年龄:</strong> ${customerAge.value||"未填写"}</p>`)+`<p><strong>联系方式:</strong> ${customerPhone.value||"未填写"}</p>`)+`<p><strong>剂数:</strong> ${currentPrescription.dose}剂</p>`)+'<table style="width:100%; border-collapse:collapse; margin:20px 0;">'+"<thead>")+'<tr style="background-color:#f8f9ff;">'+'<th style="border:1px solid #ddd; padding:8px; text-align:left;">药材名称</th>')+'<th style="border:1px solid #ddd; padding:8px; text-align:right;">数量</th>'+'<th style="border:1px solid #ddd; padding:8px; text-align:right;">单价</th>')+'<th style="border:1px solid #ddd; padding:8px; text-align:right;">金额</th>'+"</tr>")+"</thead>"+"<tbody>",currentPrescription.medicines.forEach(e=>{0<e.quantity&&(t=(t=(t=(t=(t+="<tr>")+`<td style="border:1px solid #ddd; padding:8px;">${e.商品名称}</td>`)+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">${e.quantity}${e.单位}</td>`)+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">¥${parseFloat(e.售价).toFixed(2)}</td>`)+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">¥${e.totalPrice.toFixed(2)}</td>`+"</tr>")}),t=(t=(t=(t=(t=(t=(t=(t=t+'<tr style="background-color:#f8f9ff; font-weight:bold;">'+'<td style="border:1px solid #ddd; padding:8px; text-align:right;" colspan="3">商品总价:</td>')+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">¥${parseFloat(subtotalPriceElement.textContent).toFixed(2)}</td>`+"</tr>")+'<tr style="background-color:#f8f9ff; font-weight:bold;">'+'<td style="border:1px solid #ddd; padding:8px; text-align:right;" colspan="3">运费:</td>')+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">¥${parseFloat(shippingFeeInput.value).toFixed(2)}</td>`+"</tr>")+'<tr style="background-color:#f8f9ff; font-weight:bold;">'+'<td style="border:1px solid #ddd; padding:8px; text-align:right;" colspan="3">总计:</td>')+`<td style="border:1px solid #ddd; padding:8px; text-align:right;">¥${parseFloat(totalPriceElement.textContent).toFixed(2)}</td>`+"</tr>")+"</tbody>"+"</table>")+`<p style="text-align:right; margin-top:20px;">处方日期: ${(new Date).toLocaleDateString("zh-CN")}</p>`,n.innerHTML=t,document.body.appendChild(n),"undefined"!=typeof html2canvas?html2canvas(n).then(e=>{var t=document.createElement("a");t.download="prescription.png",t.href=e.toDataURL(),t.click(),document.body.removeChild(n)}):(alert("请先引入html2canvas库以使用保存图片功能"),document.body.removeChild(n))}}function downloadFile(e,t,n){t=new Blob([t],{type:n}),n=URL.createObjectURL(t),t=document.createElement("a");t.href=n,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}function initEventListeners(){searchBtn.addEventListener("click",searchMedicines),resetBtn.addEventListener("click",resetForm),saveJsonBtn.addEventListener("click",saveAsJson),saveTxtBtn.addEventListener("click",saveAsTxt),saveImageBtn.addEventListener("click",saveAsImage),prescriptionInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchMedicines()}),shippingFeeInput.addEventListener("input",updateShippingFee),doseInput.addEventListener("input",updateDose),settlementBtn.addEventListener("click",showSettlementModal),settlementClose.addEventListener("click",closeSettlementModal),cancelSettlementBtn.addEventListener("click",closeSettlementModal),confirmSettlementBtn.addEventListener("click",showPaymentModal),paymentClose.addEventListener("click",closePaymentModal),closePaymentBtn.addEventListener("click",closePaymentModal),helpBtn.addEventListener("click",showHelpModal),helpClose.addEventListener("click",closeHelpModal),closeHelpBtn.addEventListener("click",closeHelpModal),window.addEventListener("click",e=>{e.target===settlementModal&&closeSettlementModal(),e.target===paymentModal&&closePaymentModal(),e.target===helpModal&&closeHelpModal()})}function calculatePrice(e,t,n){t*=e;return{singlePrice:t,totalPrice:t*n}}function updateSearchResultPrice(e){var t=parseInt(e.value),n=JSON.parse(e.dataset.allMedicines),i=e.closest(".medicine-item").querySelector(".quantity-input"),a=parseFloat(i.value)||0,o=n[t],r=parseFloat(o.售价),l=calculatePrice(r,a,currentPrescription.dose),s=e.closest(".medicine-item").querySelector(".medicine-details"),o=o.单位;s.innerHTML=`单位: ${o} | 单价: ¥${r.toFixed(3)} <span class="multiple-match-hint">（找到${n.length}个匹配结果）</span>`;e.closest(".medicine-item").querySelector(".medicine-price").textContent="¥"+l.totalPrice.toFixed(2),i.dataset.medicineIndex=t,e.dataset.quantity=a;s=e.closest(".medicine-item").querySelector(".add-to-prescription-btn");s.dataset.medicineIndex=t,s.dataset.allMedicines=JSON.stringify(n),s.dataset.quantity=a}function addToPrescription(t){if(t.classList.contains("added"))withdrawFromPrescription(t);else{parseInt(t.dataset.itemIndex);var n=parseInt(t.dataset.medicineIndex)||0,i=JSON.parse(t.dataset.allMedicines),n=i[n];let e=parseFloat(t.dataset.quantity);var a=t.closest(".medicine-item").querySelector(".quantity-input"),a=(a&&(e=parseFloat(a.value)||e),parseFloat(n.售价)),o=currentPrescription.dose,a=calculatePrice(a,e,o),o={...n,quantity:e,singlePrice:a.singlePrice,totalPrice:a.totalPrice,uniqueId:Date.now()+"-"+Math.random().toString(36).substr(2,9)};1<i.length&&(o.allMatches=i),currentPrescription.medicines.push(o),t.dataset.uniqueId=o.uniqueId,t.innerHTML='<i class="fa fa-undo"></i> 已添加',t.disabled=!1,t.classList.add("added"),showPrescriptionDetails(),updateTotalPrice(),doseInput.value=currentPrescription.dose}}function withdrawFromPrescription(e){let t=e.dataset.uniqueId;var n;t&&-1!==(n=currentPrescription.medicines.findIndex(e=>e.uniqueId===t))&&(currentPrescription.medicines.splice(n,1),e.innerHTML="添加到处方",e.disabled=!1,e.classList.remove("added"),e.dataset.uniqueId="",showPrescriptionDetails(),updateTotalPrice())}function removeFromPrescription(e){e=parseInt(e.dataset.index);currentPrescription.medicines.splice(e,1),showPrescriptionDetails(),updateTotalPrice()}function showPrescriptionDetails(){document.getElementById("prescription-details")||(e=document.querySelector(".container"))&&((t=document.createElement("div")).id="prescription-section",t.className="section",t.innerHTML=`
                <h2>处方详情</h2>
                <div id="prescription-details" class="prescription-details"></div>
            `,(n=document.querySelector(".prescription-input-container"))?e.insertBefore(t,n.nextSibling):e.appendChild(t));var e,t,n=document.getElementById("prescription-details");if(0===currentPrescription.medicines.length)n.innerHTML='<div class="empty-prescription">处方为空，请添加药材</div>';else{let i='<div class="prescription-medicines">';currentPrescription.medicines.forEach((e,t)=>{var n=parseFloat(e.售价);i+=`
            <div class="prescription-medicine-item">
                <div class="medicine-info">
                    <div class="medicine-name">${e.商品名称}</div>
                    <div class="medicine-details">单位: ${e.单位} | 单价: ¥${n.toFixed(2)}</div>
                </div>
                <input type="number" min="0" step="0.1" value="${e.quantity}" class="quantity-input" data-index="${t}">
                <div class="medicine-price">¥${e.totalPrice.toFixed(2)}</div>
                <button class="remove-from-prescription-btn" data-index="${t}"><i class="fa fa-times"></i> 删除</button>
            </div>
        `}),i+="</div>",n.innerHTML=i,document.querySelectorAll("#prescription-details .quantity-input").forEach(e=>{e.addEventListener("input",updatePrescriptionQuantity)})}}function updatePrescriptionQuantity(e){var t=parseInt(e.target.dataset.index),n=parseFloat(e.target.value)||0,t=currentPrescription.medicines[t],i=n*parseFloat(t.售价),a=i*currentPrescription.dose;t.quantity=n,t.singlePrice=i,t.totalPrice=a,e.target.nextElementSibling.textContent="¥"+a.toFixed(2),updateTotalPrice()}function showSettlementModal(){if(0===currentPrescription.medicines.length)alert("请先检索并填写处方信息");else{modalCustomerName.textContent=customerName.value||"未填写",modalCustomerAge.textContent=customerAge.value||"未填写",modalCustomerPhone.textContent=customerPhone.value||"未填写",modalPrescriptionDate.textContent=(new Date).toLocaleDateString("zh-CN"),modalDose.textContent=currentPrescription.dose;let t="";currentPrescription.medicines.forEach(e=>{0<e.quantity&&(t+=`
                <tr>
                    <td>${e.商品名称}</td>
                    <td>${e.quantity}${e.单位}</td>
                    <td>¥${parseFloat(e.售价).toFixed(2)}</td>
                    <td>¥${e.totalPrice.toFixed(2)}</td>
                </tr>
            `)}),modalMedicinesList.innerHTML=t,modalSubtotal.textContent="¥"+parseFloat(subtotalPriceElement.textContent).toFixed(2),modalShippingFee.textContent="¥"+parseFloat(shippingFeeInput.value).toFixed(2),modalTotal.textContent="¥"+parseFloat(totalPriceElement.textContent).toFixed(2),settlementModal.style.display="block"}}function closeSettlementModal(){settlementModal.style.display="none"}function showHelpModal(){helpModal.style.display="block"}function closeHelpModal(){helpModal.style.display="none"}async function savePrescriptionToDatabase(){console.log("开始保存处方信息到数据库...");var e={customer:{name:customerName.value||"未填写",age:customerAge.value||"未填写",phone:customerPhone.value||"未填写"},doctor:{name:"未知医生"},prescriptionDate:(new Date).toISOString(),dose:currentPrescription.dose,medicines:currentPrescription.medicines.map(e=>({name:e.商品名称,unit:e.单位,quantity:e.quantity,pricePerUnit:parseFloat(e.售价),singlePrice:e.singlePrice,totalPrice:e.totalPrice})),pricing:{subtotal:parseFloat(subtotalPriceElement.textContent),shippingFee:parseFloat(shippingFeeInput.value),totalAmount:parseFloat(totalPriceElement.textContent)},status:"pending"};console.log("处方数据:",e);try{await new Promise(e=>setTimeout(e,1e3));var t={...e,id:"presc_"+Date.now(),savedAt:(new Date).toISOString()};return console.log("处方信息保存成功:",t),localStorage.setItem("lastSavedPrescription",JSON.stringify(t)),t}catch(e){throw console.error("保存处方信息失败:",e),new Error("保存处方信息失败，请重试")}}async function showPaymentModal(){try{await savePrescriptionToDatabase(),paymentAmount.textContent="¥"+parseFloat(totalPriceElement.textContent).toFixed(2),closeSettlementModal(),paymentModal.style.display="block",console.log("显示支付二维码弹窗")}catch(e){console.error("处理结算失败:",e),alert("保存处方信息失败，请重试")}}function navigateBack(){console.log("准备返回之前的页面...");var e=document.referrer,t=localStorage.getItem("previousPage");console.log("页面来源:",e),console.log("之前保存的页面:",t);let n="中医智能分析系统.html";t&&t!==window.location.href?n=t:e&&!e.includes(window.location.hostname+"/index.html")&&(n=e),console.log("返回目标页面:",n),window.location.href=n}async function paySuccessCallback(e,t,n){try{var i,a,o={id:Date.now()+Math.floor(1e3*Math.random()),payNo:"pay_"+Date.now(),totalAmount:parseFloat(totalPriceElement.textContent),payTime:(new Date).toISOString(),prescription:t,customer:n,createTime:(new Date).toISOString()};try{var r=JSON.parse(localStorage.getItem("prescriptionRecords")||"[]");r.push(o),localStorage.setItem("prescriptionRecords",JSON.stringify(r)),console.log("本地保存处方信息成功:",o.id)}catch(e){console.error("本地保存失败：",e)}try{"undefined"!=typeof axios?200===(i=await axios.post("/api/prescription/save",o,{headers:{"Content-Type":"application/json"}})).data.code?console.log("服务器保存处方信息成功"):(console.error("服务器保存失败：",i.data.msg),alert("结算成功，本地信息已保存，服务器同步失败，请稍后手动同步")):200===(a=await(await fetch("/api/prescription/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()).code?console.log("服务器保存处方信息成功"):(console.error("服务器保存失败：",a.msg),alert("结算成功，本地信息已保存，服务器同步失败，请稍后手动同步"))}catch(e){console.error("服务器保存异常：",e),alert("结算成功，本地信息已保存，服务器请求失败")}}catch(e){console.error("保存信息异常：",e),alert("结算成功，本地信息已保存，服务器请求失败")}}function closePaymentModal(){paymentModal.style.display="none";var e={dose:currentPrescription.dose,medicines:currentPrescription.medicines.map(e=>({name:e.商品名称,quantity:e.quantity,unit:e.单位,pricePerUnit:parseFloat(e.售价),totalPrice:e.totalPrice})),subtotal:parseFloat(subtotalPriceElement.textContent),shippingFee:parseFloat(shippingFeeInput.value),totalAmount:parseFloat(totalPriceElement.textContent)},t={name:customerName.value||"未填写",age:customerAge.value||"未填写",phone:customerPhone.value||"未填写"};paySuccessCallback({success:!0,payNo:"pay_"+Date.now(),totalAmount:parseFloat(totalPriceElement.textContent)},e,t),alert("结算完成！"),setTimeout(()=>{resetForm()},1e3)}document.addEventListener("click",function(e){e.target.classList.contains("add-to-prescription-btn")&&(e.preventDefault(),addToPrescription(e.target)),e.target.classList.contains("remove-from-prescription-btn")&&(e.preventDefault(),removeFromPrescription(e.target))}),document.addEventListener("change",function(e){e.target.classList.contains("medicine-select")&&updateSearchResultPrice(e.target)});